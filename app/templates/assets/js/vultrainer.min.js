/*! vultrainer 20-06-2017 */

angular.module("dashboard",["platformNode"]).controller("nodeInfoController",["$rootScope","$scope","nodeService",function(e,o,n){function t(e){o.nodeInfo=e}function r(e){o.errorType="Retrieve Data Error : ",o.errorDetail=e,o.alertShown=!0}n.getNodeInfo(e.nodeId).then(t,r)}]),angular.module("platformNode",[]).service("nodeService",["$http","$q",function(e,o){this.nodeId="",this.setNodeId=function(e){this.nodeId=e},this.getNodeId=function(){return this.nodeId},this.getNodeInfo=function(n){var t=o.defer();return e.get("/"+n+"/dashboard/nodeinfo").then(function(e){t.resolve(e.data)},function(e){t.reject(e.data)}),t.promise}}]),angular.module("vulhub",["ngWebSocket"]).factory("vulhubService",["$http","$q","$websocket",function(e,o,n){var t={};return t.getVulhubTree=function(n){var t=o.defer();return e.get("/"+n+"/vulhubMode/tree").then(function(e){t.resolve(e.data)},function(e){t.reject(e.data)}),t.promise},t.updateVulhubTree=function(n){var t=o.defer();return e.get("/"+n+"/vulhubMode/update").then(function(e){t.resolve(e.data)},function(e){t.reject(e.data)}),t.promise},t.createVulhubCase=function(e,o,t,r,a,l){var u=n("ws://"+e+"/"+o+"/vulhubMode/setup"),c=[],d=!1,i=!1;return u.onMessage(function(e){c.push(JSON.parse(e.data)),console.log(JSON.parse(e.data).build_success),console.log(JSON.parse(e.data).up_success),"ok"==JSON.parse(e.data).build_success&&(d=!0),"ok"==JSON.parse(e.data).up_success&&(i=!0),d&&i&&(console.log("Yes"),l.uploadAll())}),{collection:c,setup:function(){u.send(JSON.stringify({case_path:t,vuln_num:r,desc:a,rep_file:l.queue[0].file.name}))}}},t}]),angular.module("vulnContainer",["ngTable","ui.bootstrap","treeControl","vulhub","angularFileUpload"]).factory("vulnContainerService",["$http","$q",function(e,o){var n={};return n.getVulnContainerList=function(n){var t=o.defer();return e.get("/"+n+"/vulnContainer/all").then(function(e){t.resolve(e.data)},function(e){t.reject(e.data)}),t.promise},n.operateContainer=function(n,t,r){var a=o.defer();return e.get("/"+n+"/vulnContainer/"+t+"/"+r).then(function(e){a.resolve(e.data)},function(e){a.reject(e.data)}),a.promise},n.downloadRepStepsFiles=function(n,t,r){var a=o.defer(),l={file_name:r};return e.post("/"+n+"/vulnContainer/"+t+"/download",l,{responseType:"arraybuffer"}).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},n}]).filter("retInnerPort",function(){return function(e){return e.split("/")[0]}}).filter("retProto",function(){return function(e){return e.split("/")[1]}}).controller("addVulnContainerModal",["$scope","$rootScope","$uibModal",function(e,o,n){e.openModal=function(){n.open({templateUrl:o.nodeId+"/vulnContainer/add",controller:"chooseAddMode",backdrop:"static"})}}]).controller("chooseAddMode",["$scope","$rootScope","$uibModalInstance","$uibModal",function(e,o,n,t){e.modalAlert=!1,e.confirm=function(){void 0===e.addMode?e.modalAlert=!0:1==e.addMode&&(e.vulhubModal=function(){t.open({templateUrl:o.nodeId+"/vulhubMode",controller:"vulhubMode",backdrop:"static"})},n.close(e.vulhubModal()))},e.cancel=function(){n.dismiss("cancel")}}]).controller("vulhubMode",["$scope","$rootScope","vulhubService","$uibModalInstance","$uibModal",function(e,o,n,t,r){function a(o){e.vulhubData=o}function l(o){e.modalAlert=!0}function u(t){console.log(t.status),"ok"==t.status&&(e.updateStatus=0,n.getVulhubTree(o.nodeId).then(a,l))}e.vulhubTreeOptions={nodeChildren:"children",dirSelectable:!1},e.selectedNode="",e.showSelected=function(o){e.selectedNode=o},n.getVulhubTree(o.nodeId).then(a,l),e.updateStatus=0,e.update=function(){e.updateStatus=1,n.updateVulhubTree(o.nodeId).then(u,l)},e.next=function(){e.createVulhubModal=function(){r.open({templateUrl:o.nodeId+"/vulhubMode/create",controller:"createVulhubController",backdrop:"static",keyboard:!1,resolve:{cur_case:e.selectedNode}})},t.close(e.createVulhubModal())},e.cancel=function(){t.dismiss("cancel")}}]).controller("createVulhubController",["$scope","$rootScope","vulhubService","$uibModalInstance","$uibModal","FileUploader","cur_case",function(e,o,n,t,r,a,l){e.cur_case=l,e.vuln_number="",e.description="",e.fileUploader=new a({url:"1/vulhubMode/upload",alias:"rep_steps",queueLimit:1}),e.cancel=function(){t.dismiss("cancel")},e.confirm=function(){e.logData=n.createVulhubCase(window.location.host,o.nodeId,l.full_path,e.vuln_number,e.description,e.fileUploader),e.logData.setup(),console.log(e.logData)}}]).controller("vulnContainerController",["$rootScope","$scope","$timeout","vulnContainerService","NgTableParams",function(e,o,n,t,r){function a(e){u.containerTableParams=new r({},{dataset:e})}function l(e){o.errorType="Retrieve Data Error : ",o.errorDetail=e,o.alertShown=!0}var u=this;t.getVulnContainerList(e.nodeId).then(a,l),o.containerCheckeds=[],o.selectContainer=function(e){if(1==e.checked)o.containerCheckeds.push(e.id);else for(var n=0;n<o.containerCheckeds.length;n++)o.containerCheckeds[n]==e.id&&o.containerCheckeds.splice(n,1);console.log(o.containerCheckeds)},o.containerAction=function(n){function r(o){t.getVulnContainerList(e.nodeId).then(a,l)}function u(e){o.errorType="Operated Failed : ",o.errorDetail=e,o.alertShown=!0}for(var c=0;c<o.containerCheckeds.length;c++)t.operateContainer(e.nodeId,o.containerCheckeds[c],n).then(r,u);o.containerCheckeds=[]},o.downloadAction=function(n,r){function a(e){var o=new Blob([e.data],{type:e.headers("Content-Type")}),n=URL.createObjectURL(o);window.open(n)}function l(e){o.errorType="Download Failed : ",o.errorDetail=e,o.alertShown=!0}t.downloadRepStepsFiles(e.nodeId,n,r).then(a,l)}}]),angular.module("vultrainer",["ui.router","platformNode","dashboard","vulnContainer"]).config(["$stateProvider","$urlRouterProvider",function(e,o){o.otherwise("/dashboard/"),e.state("dashboard",{url:"/dashboard/",templateUrl:"/dashboard/",controller:"vultrainerController"}).state("vulnContainer",{url:"/vulnContainer/",templateUrl:"/vulnContainer/",controller:"vultrainerController"})}]).controller("vultrainerController",["$rootScope","$scope","nodeService",function(e,o,n){n.setNodeId(1),e.nodeId=n.getNodeId()}]);